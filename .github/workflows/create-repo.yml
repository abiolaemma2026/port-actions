name: Create GitHub Repository

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: 'Name of the repository to create'
        required: true
        type: string
      description:
        description: 'Repository description'
        required: false
        type: string
        default: ''
      private:
        description: 'Make repository private'
        required: false
        type: boolean
        default: false
      initialize_readme:
        description: 'Initialize with README'
        required: false
        type: boolean
        default: true
      port_run_id:
        description: 'Port run ID (leave empty for manual runs)'
        required: false
        type: string
        default: ''

jobs:
  create-repository:
    runs-on: ubuntu-latest
    steps:
      - name: Inform Port of workflow start
        if: ${{ inputs.port_run_id != '' }}
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          logMessage: |
            Starting repository creation workflow for: ${{ inputs.repo_name }} ðŸš€

      - name: Create GitHub Repository
        id: create_repo
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            try {
              const repoName = '${{ inputs.repo_name }}';
              const description = '${{ inputs.description }}' || '';
              const isPrivate = '${{ inputs.private }}' === 'true';
              const initReadme = '${{ inputs.initialize_readme }}' === 'true';
              
              console.log(`Creating repository: ${repoName}`);
              console.log(`Private: ${isPrivate}, Initialize README: ${initReadme}`);
              
              const response = await github.rest.repos.createInOrg({
                org: context.repo.owner,
                name: repoName,
                description: description,
                private: isPrivate,
                auto_init: initReadme
              });
              
              console.log(`âœ… Repository created successfully: ${response.data.html_url}`);
              
              core.setOutput('repo_url', response.data.html_url);
              core.setOutput('repo_full_name', response.data.full_name);
              core.setOutput('repo_id', response.data.id);
              
              return response.data;
            } catch (error) {
              core.setFailed(`Failed to create repository: ${error.message}`);
              throw error;
            }

      - name: Report success to Port
        if: ${{ success() && inputs.port_run_id != '' }}
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCHSECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          logMessage: |
            âœ… Repository created successfully!
            ðŸ”— URL: ${{ steps.create_repo.outputs.repo_url }}
            ðŸ“¦ Full Name: ${{ steps.create_repo.outputs.repo_full_name }}

      - name: Report failure to Port
        if: ${{ failure() && inputs.port_run_id != '' }}
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          logMessage: |
            âŒ Failed to create repository: ${{ inputs.repo_name }}
            Check the workflow logs for details.

      - name: Summary
        run: |
          echo "### Repository Creation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Repository Created Successfully**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Name:** ${{ steps.create_repo.outputs.repo_full_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** ${{ steps.create_repo.outputs.repo_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Private:** ${{ inputs.private }}" >> $GITHUB_STEP_SUMMARY
          echo "- **README:** ${{ inputs.initialize_readme }}" >> $GITHUB_STEP_SUMMARY