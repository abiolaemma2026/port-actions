name: Create New Repository

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: 'Repository name'
        required: true
        type: string
      description:
        description: 'Repository description'
        required: false
        type: string
        default: 'Created via Port and GitHub Actions'
      private:
        description: 'Make repository private'
        required: false
        type: string
        default: 'false'
      initialize_readme:
        description: 'Initialize with README'
        required: false
        type: string
        default: 'true'
      port_run_id:
        description: 'Port run ID for status updates'
        required: false
        type: string

jobs:
  create-repo:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Port - Started
        if: inputs.port_run_id != ''
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          logMessage: "üöÄ Starting repository creation for ${{ inputs.repo_name }}..."

      - name: Create repository
        id: create_repo
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          REPO_NAME: ${{ inputs.repo_name }}
          DESCRIPTION: ${{ inputs.description }}
          PRIVATE: ${{ inputs.private }}
          INIT_README: ${{ inputs.initialize_readme }}
        run: |
          # Build the command
          CMD="gh repo create abiolaemma2026/${REPO_NAME}"
          CMD="$CMD --description '${DESCRIPTION}'"
          
          # Handle private flag (convert string to boolean logic)
          if [ "${PRIVATE}" = "true" ]; then
            CMD="$CMD --private"
          else
            CMD="$CMD --public"
          fi
          
          # Handle README flag (convert string to boolean logic)
          if [ "${INIT_README}" = "true" ]; then
            CMD="$CMD --add-readme"
          fi
          
          CMD="$CMD --confirm"
          
          # Execute
          echo "Executing: $CMD"
          eval $CMD
          
          echo "repo_url=https://github.com/abiolaemma2026/${REPO_NAME}" >> $GITHUB_OUTPUT

      - name: Notify Port - Success
        if: success() && inputs.port_run_id != ''
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          status: "SUCCESS"
          logMessage: "‚úÖ Repository created successfully!"
          link: ${{ steps.create_repo.outputs.repo_url }}

      - name: Notify Port - Failure
        if: failure() && inputs.port_run_id != ''
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          status: "FAILURE"
          logMessage: "‚ùå Failed to create repository. Check workflow logs for details."