name: Create Repository with Approval

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: 'Repository name'
        required: true
        type: string
      repo_description:
        description: 'Repository description'
        required: false
        type: string
      port_context:
        description: 'Port context'
        required: false
        type: string

jobs:
  request-approval:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Port - Waiting for Approval
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(inputs.port_context).runId }}
          logMessage: "â³ Waiting for manual approval to create repository: ${{ inputs.repo_name }}"

  approve-creation:
    runs-on: ubuntu-latest
    needs: request-approval
    environment: 
      name: production-approval
    steps:
      - name: Approval Granted
        run: echo "âœ… Repository creation approved for ${{ inputs.repo_name }}"
      
      - name: Notify Port - Approved
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(inputs.port_context).runId }}
          logMessage: "âœ… Approval granted! Creating repository..."

  create-repo:
    runs-on: ubuntu-latest
    needs: approve-creation
    steps:
      - name: Create Repository
        id: create-repo
        run: |
          RESPONSE=$(curl -X POST \
            -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/orgs/abiolaemma/repos \
            -d '{
              "name": "${{ inputs.repo_name }}",
              "description": "${{ inputs.repo_description }}",
              "private": false,
              "auto_init": true
            }')
          
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT
          REPO_URL=$(echo $RESPONSE | jq -r '.html_url')
          echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT

      - name: Wait for Repository Initialization
        run: sleep 5

      - name: Checkout New Repository
        uses: actions/checkout@v4
        with:
          repository: abiolaemma/${{ inputs.repo_name }}
          token: ${{ secrets.GH_TOKEN }}
          path: new-repo

      - name: Create GitHub Actions Workflow Files
        run: |
          mkdir -p new-repo/.github/workflows
          
          cat > new-repo/.github/workflows/ci.yml << 'EOF'
          name: CI

          on:
            push:
              branches: [ main ]
            pull_request:
              branches: [ main ]

          jobs:
            build:
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4
                - name: Run tests
                  run: echo "Add your build and test commands here"
          EOF
          
          cat > new-repo/.github/workflows/cd.yml << 'EOF'
          name: CD

          on:
            push:
              tags:
                - 'v*'

          jobs:
            deploy:
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4
                - name: Deploy
                  run: echo "Add your deployment commands here"
          EOF

      - name: Update README
        run: |
          cat >> new-repo/README.md << EOF
          
          ## ðŸš€ Getting Started
          
          This repository was created via Port self-service action.
          
          ## ðŸ“‹ Included Workflows
          
          - **CI Workflow** (`.github/workflows/ci.yml`) - Runs on push/PR to main
          - **CD Workflow** (`.github/workflows/cd.yml`) - Runs on version tags
          
          ## ðŸ› ï¸ Setup
          
          1. Clone this repository
          2. Customize the workflows in `.github/workflows/`
          3. Start building!
          
          ---
          Created: $(date)
          EOF

      - name: Commit and Push Files
        run: |
          cd new-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Add GitHub Actions workflows and update README"
          git push

      - name: Notify Port - Success
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(inputs.port_context).runId }}
          logMessage: |
            âœ… Repository created successfully!
            ðŸ”— URL: ${{ steps.create-repo.outputs.repo_url }}
            ðŸ“ Includes: README.md, CI workflow, CD workflow

      - name: Create Port Entity
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: UPSERT
          identifier: ${{ inputs.repo_name }}
          blueprint: service
          properties: |
            {
              "name": "${{ inputs.repo_name }}",
              "description": "${{ inputs.repo_description }}",
              "url": "${{ steps.create-repo.outputs.repo_url }}"
            }

      - name: Notify Port - Complete
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(inputs.port_context).runId }}
          status: "SUCCESS"
          link: ${{ steps.create-repo.outputs.repo_url }}

      - name: Notify Port - Failed
        if: failure()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(inputs.port_context).runId }}
          status: "FAILURE"
          logMessage: "âŒ Failed to create repository. Check workflow logs for details."
