name: Create GitHub Repository with Approval

on:
  workflow_dispatch:
    inputs:
      port_context:
        required: true
        description: "Port's context (entity, run ID, etc.)"
      repo_name:
        required: true
        description: "Name of the repository to create"
      repo_description:
        required: false
        description: "Description of the repository"
        default: "Created via Port"
      repo_private:
        required: false
        description: "Whether the repository should be private"
        default: "true"

jobs:
  create-repository:
    runs-on: ubuntu-latest
    
    steps:
      - name: Log Inputs
        run: |
          echo "Repository Name: ${{ inputs.repo_name }}"
          echo "Description: ${{ inputs.repo_description }}"
          echo "Private: ${{ inputs.repo_private }}"

      - name: Notify Port - Starting
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(inputs.port_context).runId }}
          logMessage: "üöÄ Starting repository creation: ${{ inputs.repo_name }}"

      - name: Create Repository
        id: create_repo
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          REPO_NAME: ${{ inputs.repo_name }}
          REPO_DESC: ${{ inputs.repo_description }}
          REPO_PRIVATE: ${{ inputs.repo_private }}
        run: |
          if [ -z "$REPO_NAME" ]; then
            echo "Error: Repository name is empty!"
            exit 1
          fi
          
          echo "Creating repository: $REPO_NAME"
          
          if [ "$REPO_PRIVATE" = "true" ]; then
            PRIVATE_FLAG="--private"
          else
            PRIVATE_FLAG="--public"
          fi
          
          gh repo create "abiolaemma2026/$REPO_NAME" \
            $PRIVATE_FLAG \
            --description "$REPO_DESC" \
            --clone=false
          
          REPO_URL="https://github.com/abiolaemma2026/$REPO_NAME"
          echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Repository created: $REPO_URL"

      - name: Initialize with README
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          REPO_NAME: ${{ inputs.repo_name }}
          REPO_DESC: ${{ inputs.repo_description }}
        run: |
          git clone "https://github.com/abiolaemma2026/$REPO_NAME.git"
          cd "$REPO_NAME"
          echo "# $REPO_NAME" > README.md
          echo "" >> README.md
          echo "$REPO_DESC" >> README.md
          git config user.name "Port Bot"
          git config user.email "bot@getport.io"
          git add README.md
          git commit -m "Initial commit"
          git push origin main || git push origin master

      - name: Notify Port - Success
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(inputs.port_context).runId }}
          logMessage: |
            ‚úÖ Repository created successfully!
            üîó ${{ steps.create_repo.outputs.repo_url }}
          link: ${{ steps.create_repo.outputs.repo_url }}

      - name: Notify Port - Failure
        if: failure()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(inputs.port_context).runId }}
          logMessage: "‚ùå Failed to create repository: ${{ inputs.repo_name }}"