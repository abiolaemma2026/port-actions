name: Create GitHub Repository with Approval

on:
  workflow_dispatch:
    inputs:
      repository_name:
        description: 'Name of the new repository'
        required: true
        type: string
      repo_description:
        description: 'Brief description of the repository'
        required: false
        type: string
      port_context:
        description: 'Port context'
        required: true
        type: string

jobs:
  create-repository:
    runs-on: ubuntu-latest
    steps:
      - name: Inform Port of workflow start
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(inputs.port_context).runId }}
          logMessage: 'Starting repository creation...'

      - name: Create GitHub Repository
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const repoName = '${{ inputs.repository_name }}';
            const repoDescription = '${{ inputs.repo_description }}' || '';
            
            await github.rest.repos.createInOrg({
              org: 'abiolaemma2026',
              name: repoName,
              description: repoDescription,
              private: false,
              auto_init: true
            });
            
            console.log(`Repository ${repoName} created successfully`);

      - name: Report success to Port
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(inputs.port_context).runId }}
          logMessage: 'Repository created successfully ✅'

      - name: Report failure to Port
        if: failure()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(inputs.port_context).runId }}
          logMessage: 'Failed to create repository ❌'